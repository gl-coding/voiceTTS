# 一键续期功能详解

## 🔄 功能概述

一键续期功能允许用户快速为已生成的音频记录重新生成预签名URL，无需重新生成整个音频文件。这是一个高效、便捷的URL管理工具。

## ✨ 核心特性

### 1. 快速续期
- ⚡ **几秒完成**：无需等待音频生成过程
- 🎯 **直接生效**：立即获得新的可用URL
- 💾 **节省资源**：不重新生成音频，只更新URL

### 2. 灵活选择
- 📅 **7个时长选项**：1小时到7天
- 🔄 **无限次数**：可以多次续期
- 🎨 **友好界面**：模态对话框操作

### 3. 智能提示
- 📊 **显示当前状态**：过期时间、剩余时间
- ⚠️ **安全提醒**：旧URL失效警告
- ✅ **结果反馈**：成功/失败即时通知

## 🎯 使用指南

### 基本操作流程

```
1. 访问记录页面
   ↓
2. 点击"续期URL"按钮（黄色）
   ↓
3. 选择新的有效期
   ↓
4. 点击"确认续期"
   ↓
5. 获得新URL✓
```

### 详细步骤

#### 步骤1：找到需要续期的记录

**方式A：在结果页面**
- 生成完成后立即显示
- 黄色"续期URL"按钮位于下载按钮旁边

**方式B：在记录详情页**
- 从记录列表进入
- 查看完整信息后续期

#### 步骤2：打开续期对话框

点击 **"续期URL"** 按钮，会弹出模态对话框：

```
┌─────────────────────────────────────┐
│  🔄 续期预签名URL                   │
├─────────────────────────────────────┤
│  ℹ️ 续期将为音频文件生成新的预签   │
│     名URL，不会重新生成音频。       │
│                                      │
│  🕐 选择新的有效期                  │
│  ┌─────────────────────────────┐   │
│  │ 6小时 ▼                      │   │
│  └─────────────────────────────┘   │
│  当前过期时间: 2024-01-01 13:00:00 │
│  (剩余 2小时30分钟)                │
│                                      │
│  ⚠️ 注意: 续期后旧的URL将立即失效  │
├─────────────────────────────────────┤
│  [取消]           [确认续期]        │
└─────────────────────────────────────┘
```

#### 步骤3：选择新的有效期

可选的时长：

| 选项 | 推荐场景 |
|------|---------|
| 1小时 | 临时测试 |
| 2小时 | 短时演示 |
| 6小时 | 半天使用 |
| 12小时 | 工作时间 |
| 24小时 | 一整天 |
| 3天 | 短期项目 |
| 7天 | 长期使用 |

#### 步骤4：确认续期

点击 **"确认续期"** 按钮后：

1. 系统检查文件是否存在
2. 生成新的预签名URL
3. 更新数据库记录
4. 显示成功消息
5. 页面自动刷新

## 💡 使用场景

### 场景1：紧急续期

**情况**：正在使用URL，发现还有5分钟过期

```
操作步骤：
1. 快速点击"续期URL"
2. 选择"6小时"
3. 确认续期
4. 复制新URL替换旧URL

时间消耗：< 10秒
```

### 场景2：批量分享

**情况**：需要将音频分享给多人，希望延长有效期

```
操作步骤：
1. 打开记录详情
2. 点击"续期URL"
3. 选择"7天"
4. 确认续期
5. 复制新URL发送给团队

优势：统一延长所有分享链接的有效期
```

### 场景3：恢复访问

**情况**：URL已过期，需要重新访问

```
操作步骤：
1. 访问记录详情页
2. 看到"已过期"红色标记
3. 点击"续期URL"
4. 选择合适的时长
5. 确认续期

结果：立即恢复访问权限
```

### 场景4：调整策略

**情况**：原本设置1小时，但发现需要更长时间

```
操作步骤：
1. 在URL还未过期时续期
2. 选择更长的时长（如24小时）
3. 确认续期

好处：及时调整，避免中断
```

## 🛡️ 安全机制

### 1. 权限检查

```python
# 只有成功状态的记录才能续期
if record.status != 'success':
    return error("只有成功生成的记录才能续期")
```

### 2. 文件验证

```python
# 确保音频文件存在
if not os.path.exists(record.path):
    return error("音频文件不存在，无法续期")
```

### 3. 旧URL失效

- 续期后旧URL立即失效
- 防止URL滥用
- 保护资源安全

## ⚙️ 技术实现

### 后端逻辑

```python
@require_http_methods(["POST"])
def renew_url(request, record_id):
    """续期预签名URL"""
    record = get_object_or_404(AudioRecord, id=record_id)
    
    # 检查状态
    if record.status != 'success':
        return error_response()
    
    # 获取时长
    expire_seconds = int(request.POST.get('expire_time', 3600))
    
    # 重新生成URL
    success, preurl, expire_time, error = storage_service.generate_presigned_url(
        object_key=os.path.basename(record.path),
        expires=expire_seconds
    )
    
    # 更新记录
    if success:
        record.preurl = preurl
        record.expire_time = expire_time
        record.save()
    
    return redirect('record_detail', record_id)
```

### 前端界面

- Bootstrap 5 模态对话框
- 下拉选择器
- 实时状态显示
- 友好的错误提示

## 📊 与重新生成的对比

| 特性 | 续期功能 | 重新生成 |
|------|---------|---------|
| 速度 | ⚡ 几秒 | ⏱️ 几分钟 |
| 资源 | 💾 极少 | 🔥 较多 |
| 音频 | ♻️ 复用 | 🆕 新生成 |
| 记录 | 📝 更新 | 🆕 新建 |
| 成本 | 💰 低 | 💰💰 高 |

**结论**：当只需要延长访问时间时，续期是最优选择。

## 🚀 最佳实践

### 1. 及时续期

```
❌ 错误做法：等到URL过期后才续期
✅ 正确做法：发现即将过期时就续期
```

### 2. 合理选择时长

```
❌ 错误做法：总是选择最长的7天
✅ 正确做法：根据实际需求选择合适时长
```

### 3. 更新保存的链接

```
❌ 错误做法：续期后继续使用旧URL
✅ 正确做法：及时更新所有保存的链接
```

### 4. 记录续期操作

```
建议：在团队协作时，通知相关人员URL已更新
```

## 🔧 故障排除

### 问题1：续期按钮不显示

**原因**：记录状态不是"成功"

**解决**：只有成功生成的记录才有续期按钮

### 问题2：续期失败

**可能原因**：
- 音频文件已删除
- 网络连接问题
- 对象存储服务异常

**解决方法**：
1. 检查文件是否存在
2. 重试续期操作
3. 如果仍失败，考虑重新生成

### 问题3：续期后旧URL仍然有效

**说明**：这是不可能的，旧URL会立即失效

**检查**：
- 确认是否使用了新URL
- 清除浏览器缓存

## 📈 未来优化方向

- [ ] 自动续期：即将过期时自动续期
- [ ] 批量续期：一次续期多个记录
- [ ] 续期历史：记录续期操作历史
- [ ] 智能推荐：根据使用习惯推荐时长
- [ ] 邮件通知：过期前发送提醒邮件

## 🔗 相关文档

- [README.md](README.md) - 项目整体说明
- [EXPIRE_TIME_FEATURE.md](EXPIRE_TIME_FEATURE.md) - 过期时间功能
- [SEARCH_FEATURE.md](SEARCH_FEATURE.md) - 搜索功能说明

